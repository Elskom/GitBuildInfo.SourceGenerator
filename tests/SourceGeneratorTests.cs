namespace GitBuildInfo.SourceGenerator.Tests
{
    using System.IO;
    using System.Threading.Tasks;
    using Microsoft.CodeAnalysis.Testing;
    using Microsoft.CodeAnalysis.Testing.Verifiers;
    using Xunit;

    public class SourceGeneratorTests
    {
        [Fact]
        public async Task TestGeneratingDefaultNamespace()
        {
            await RunTest<CSGeneratorTest>("Elskom.Generic.Libs.Test", "false", @"// <autogenerated/>
using Elskom.Generic.Libs;

[assembly: GitInformationAttribute(""fbgtgretgtre"", ""vfdbttregter"", ""vsdfvfdsv"", typeof(Test))]
", @"namespace Elskom.Generic.Libs {
    internal static class Test
    {
        internal static object Dummy()
            => null;
    }
}").ConfigureAwait(false);
        }

        [Fact]
        public async Task TestGeneratingNoNamespace()
        {
            await RunTest<CSGeneratorTest>("Test", "false", @"// <autogenerated/>
using Elskom.Generic.Libs;

[assembly: GitInformationAttribute(""fbgtgretgtre"", ""vfdbttregter"", ""vsdfvfdsv"", typeof(Test))]
", @"namespace Elskom.Generic.Libs {
    internal static class Test
    {
        internal static object Dummy()
            => null;
    }
}").ConfigureAwait(false);
        }

        [Fact]
        public async Task TestGeneratingNonGeneric()
        {
            await RunTest<CSGeneratorTest>("TestNamespace.Test", "false", @"// <autogenerated/>
using Elskom.Generic.Libs;
using TestNamespace;

[assembly: GitInformationAttribute(""fbgtgretgtre"", ""vfdbttregter"", ""vsdfvfdsv"", typeof(Test))]
", @"namespace TestNamespace {
    internal static class Test
    {
        internal static object Dummy()
            => null;
    }
}").ConfigureAwait(false);
        }

        [Fact]
        public async Task TestGeneratingGeneric()
        {
            await RunTest<CSGeneratorTest>("TestNamespace.Test", "true", @"// <autogenerated/>
using Elskom.Generic.Libs;
using TestNamespace;

[assembly: GitInformationAttribute(""fbgtgretgtre"", ""vfdbttregter"", ""vsdfvfdsv"", typeof(Test<>))]
", @"namespace TestNamespace {
    internal static class Test<T>
    {
        internal static object Dummy()
            => null;
    }
}").ConfigureAwait(false);
        }

        [Fact]
        public async Task TestGeneratingFailure()
        {
            await RunTest<CSGeneratorTest>(
                string.Empty,
                "false",
                string.Empty,
                string.Empty,
                new DiagnosticResult(GeneratorOptions.ValidationWarning).WithArguments("AssemblyType")).ConfigureAwait(false);
        }

        [Fact]
        public async Task TestVBGeneratingAbort()
        {
            await RunTest<VBGeneratorTest>(
                string.Empty,
                "false",
                string.Empty,
                string.Empty).ConfigureAwait(false);
        }

        private static async Task RunTest<TestType>(string assemblyType, string isGeneric, string generatedSource, string testSource, DiagnosticResult? expectedDiagnostic = null)
            where TestType : SourceGeneratorTest<XUnitVerifier>, IGeneratorTestBase, new()
        {
            var test = new TestType
            {
                GlobalOptions =
                {
                    ("build_property.GitBuildInfoAssemblyType", assemblyType),
                    ("build_property.GitBuildInfoIsGeneric", isGeneric),
                    ("build_property.GitHead", "fbgtgretgtre"),
                    ("build_property.CommitHash", "vfdbttregter"),
                    ("build_property.GitBranch", "vsdfvfdsv"),
                },
                ReferenceAssemblies = ReferenceAssemblies.Net.Net50,
                TestState =
                {
                    Sources =
                    {
                        testSource
                    },
                },
            };
            if (expectedDiagnostic is not null)
            {
                test.ExpectedDiagnostics.Add(expectedDiagnostic.Value);
            }

            if (test is not VBGeneratorTest)
            {
                // do not duplicate the code to Elskom.GitInformation here.
                test.TestState.Sources.Add(
                    File.ReadAllText(
                        "../../../../src/Elskom.GitInformation/GitInformationAttribute.cs"));
                test.TestState.Sources.Add(
                    File.ReadAllText(
                        "../../../../src/Elskom.GitInformation/GitInformation.cs"));
                test.TestState.GeneratedSources.Add(
                    (typeof(SourceGenerator), "GitAssemblyInfo.g.cs", generatedSource));
            }

            await test.RunAsync();
        }
    }
}
